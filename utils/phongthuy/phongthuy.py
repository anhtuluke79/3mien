from .can_chi_dict import data as CAN_CHI_SO_HAP
from .thien_can import CAN_INFOfrom thien_can import CAN_INFO

def chuan_hoa_can_chi(s):
    """Chuáº©n hÃ³a tÃªn can chi, viáº¿t hoa Ä‘áº§u má»—i tá»«."""
    return ' '.join(word.capitalize() for word in s.strip().split())

def get_can_chi_ngay(year, month, day):
    """TÃ­nh can chi cho ngÃ y dÆ°Æ¡ng lá»‹ch báº¥t ká»³."""
    if month < 3:
        year -= 1
        month += 12
    a = year // 100
    b = 2 - a + a // 4
    jd = int(365.25 * (year + 4716)) + int(30.6001 * (month + 1)) + day + b - 1524
    chi_list = ['TÃ½', 'Sá»­u', 'Dáº§n', 'MÃ£o', 'ThÃ¬n', 'Tá»µ', 'Ngá»', 'MÃ¹i', 'ThÃ¢n', 'Dáº­u', 'Tuáº¥t', 'Há»£i']
    can_list = ['GiÃ¡p', 'áº¤t', 'BÃ­nh', 'Äinh', 'Máº­u', 'Ká»·', 'Canh', 'TÃ¢n', 'NhÃ¢m', 'QuÃ½']
    chi = chi_list[(jd + 1) % 12]
    can = can_list[(jd + 9) % 10]
    return f"{can} {chi}"

def sinh_so_hap_cho_ngay(can_chi_str):
    """Láº¥y bá»™ sá»‘ háº¡p cho ngÃ y cÃ³ can chi cá»¥ thá»ƒ."""
    code = CAN_CHI_SO_HAP.get(can_chi_str)
    if not code:
        return None
    so_dau, rest = code.split('-')
    so_ghep = rest.split(',')
    can = can_chi_str.split()[0]
    info = CAN_INFO.get(can, {})
    so_menh = so_dau
    so_list = [so_menh] + so_ghep
    ket_qua = set()
    for i in range(len(so_list)):
        for j in range(len(so_list)):
            if i != j:
                ket_qua.add(so_list[i] + so_list[j])
    return {
        "can": can,
        "am_duong": info.get("am_duong"),
        "ngu_hanh": info.get("ngu_hanh"),
        "so_menh": so_menh,
        "so_hap_list": so_ghep,
        "so_ghÃ©p": sorted(list(ket_qua))
    }

def phong_thuy_format(can_chi, sohap_info, is_today=False, today_str=None):
    """Táº¡o chuá»—i káº¿t quáº£ phong thá»§y Ä‘áº¹p, tráº£ vá» cho bot."""
    can = can_chi.split()[0]
    can_info = CAN_INFO.get(can, {})
    am_duong = can_info.get("am_duong", "?")
    ngu_hanh = can_info.get("ngu_hanh", "?")
    if sohap_info and 'so_hap_list' in sohap_info and len(sohap_info['so_hap_list']) >= 1:
        so_hap_can = sohap_info['so_menh']
        so_menh = ','.join(sohap_info['so_hap_list'])
    else:
        so_hap_can, so_menh = "?", "?"
    so_hap_ngay = ','.join(sohap_info['so_ghÃ©p']) if sohap_info and 'so_ghÃ©p' in sohap_info else "?"
    if is_today and today_str:
        main_line = f"ðŸ”® Phong thá»§y NGÃ€Y HIá»†N Táº I: {can_chi} ({today_str})"
    else:
        main_line = f"ðŸ”® Phong thá»§y sá»‘ ngÅ© hÃ nh cho ngÃ y {can_chi}:"
    text = (
        f"{main_line}\n- Can: {can}, {am_duong} {ngu_hanh}, sá»‘ háº¡p {so_hap_can}\n"
        f"- Sá»‘ má»‡nh: {so_menh}\n- Sá»‘ háº¡p ngÃ y: {so_hap_ngay}"
    )
    return text
